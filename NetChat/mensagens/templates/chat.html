<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <title>NetChat</title>
</head>

<body>
    <header class="netchat">NetChat</header>

    <div class="settings-btn" onclick="toggleSettings()">âš™</div>

    <div id="settingsMenu" class="settings-menu">
        <button onclick="setTheme('theme-red')">Vermelho</button>
        <button onclick="setTheme('theme-green')">Verde</button>
        <button onclick="setTheme('theme-yellow')">Amarelo</button>
        <button onclick="setTheme('theme-white')">Branco</button>
    </div>

    <nav class="nav-links">
        <a href="/chat">Voltar</a>
        <a href="/">InÃ­cio</a>
    </nav>

    <h2>Sala: {{ channel }}</h2>

    <div id="messages" class="box"></div>

    <div class="input-area">
        <input id="fileInput" type="file">
        <button id="sendFile">Enviar arquivo</button>
    </div>

    <div class="input-area">
        <input id="msg" placeholder="Mensagem...">
        <button id="send">Enviar</button>
        <button id="openStickers" class="sticker-btn">ðŸ˜€ Figurinhas</button>
    </div>

    <div id="stickerPanel" class="sticker-panel">
        <h3>Figurinhas</h3>
        <div id="stickerList" class="sticker-list"></div>
    </div>

    <script>
        const sala = "{{ channel }}";
        const username = "{{ username }}";
        const socket = io();

        function toggleSettings() {
            const m = document.getElementById('settingsMenu');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        function setTheme(t) {
            document.body.className = t;
            localStorage.setItem('theme', t);
        }

        window.onload = () => {
            document.body.className = localStorage.getItem('theme') || 'theme-red';
        };

        socket.emit('join', { sala: sala, username: username });

        socket.on('history', data => {
            const box = document.getElementById('messages');
            box.innerHTML = '';
            data.forEach(renderMessage);
            box.scrollTop = box.scrollHeight;
        });

        socket.on('mensagem', data => {
            renderMessage(data);
            const box = document.getElementById('messages');
            box.scrollTop = box.scrollHeight;
        });

        socket.on('system_command', d => {
            if (d.cmd === '!torre') {
                const msgs = document.querySelectorAll('#messages > *');

                // comeÃ§a a tremer tudo
                msgs.forEach(m => m.classList.add('desmoronando'));

                // depois de 600ms, comeÃ§am a cair
                setTimeout(() => {
                    msgs.forEach((m, i) => {
                        setTimeout(() => {
                            m.classList.remove('desmoronando');
                            m.classList.add('caindo');
                        }, i * 50);
                    });
                }, 600);

                // desconecta sÃ³ depois da queda toda
                setTimeout(() => {
                    alert(d.msg);
                    socket.disconnect();
                    window.location.href = '/';
                }, 1600);
            }
        });

        function renderMessage(data) {
            const box = document.getElementById('messages');

            if (data.type === 'msg') {
                box.innerHTML += `<b>${data.username}:</b> ${data.text}<br>`;
            }
            else if (data.type === 'sys') {
                box.innerHTML += `<i>${data.text}</i><br>`;
            }
            else if (data.type === 'file') {
                box.innerHTML += `
                    <b>${data.username}:</b><br>
                    <a href="${data.base64}" download="${data.filename}">
                        [Baixar ${data.filename}]
                    </a><br>
                `;
            }
            else if (data.type === 'sticker') {
                box.innerHTML += `
                    <b>${data.username}:</b><br>
                    <img src="${data.base64}" class="sticker-img"><br>
                `;
            }
        }

        document.getElementById('send').onclick = () => {
            const texto = document.getElementById('msg').value.trim();
            if (!texto) return;

            socket.emit('mensagem', {
                sala: sala,
                username: username,
                text: texto
            });

            document.getElementById('msg').value = '';
        };

        document.getElementById('sendFile').onclick = () => {
            const f = document.getElementById('fileInput').files[0];
            if (!f) return alert('Escolha um arquivo.');

            const fd = new FormData();
            fd.append('file', f);
            fd.append('room', sala);
            fd.append('username', username);

            fetch('/upload', { method: 'POST', body: fd });
        };

        document.getElementById("openStickers").onclick = () => {
            const p = document.getElementById("stickerPanel");
            p.style.display = p.style.display === "block" ? "none" : "block";
        };

        fetch("/stickers")
            .then(r => r.json())
            .then(stickers => {
                const list = document.getElementById("stickerList");

                stickers.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.className = "sticker-thumb";
                    img.onclick = () => sendSticker(url);
                    list.appendChild(img);
                });
            });

        function sendSticker(url) {
            fetch(url)
                .then(r => r.blob())
                .then(blob => {
                    const reader = new FileReader();

                    reader.onloadend = () => {
                        socket.emit("mensagem", {
                            sala: sala,
                            username: username,
                            type: "sticker",
                            base64: reader.result
                        });
                    };

                    reader.readAsDataURL(blob);
                });
        }
    </script>

</body>
</html>
